// build-slide.mjs
import {createClient} from '@sanity/client'
import fs from 'fs'

// Sanity client configuration
const client = createClient({
  projectId: 'mb7v1vpy',
  dataset: 'production',
  useCdn: false,
  apiVersion: '2024-01-01',
})

// Theme colour mapping
const themeColours = {
  teal: {accent: '#00A3A3'},
  coral: {accent: '#FF6B5B'},
  gold: {accent: '#E5A93D'},
  purple: {accent: '#7B5EA7'},
  navy: {accent: '#00005E'},
}

// Parse CSV to array
function parseCSV(csv) {
  const lines = csv.trim().split('\n')
  const headers = lines[0].split(',').map(h => h.trim())
  
  return lines.slice(1).map(line => {
    const values = line.split(',')
    const obj = {}
    headers.forEach((header, i) => {
      const val = values[i]?.trim()
      obj[header] = isNaN(val) ? val : parseFloat(val)
    })
    return obj
  })
}

// Convert Sanity portable text to HTML
function portableTextToHTML(blocks) {
  if (!blocks) return ''
  
  return blocks
    .filter(block => block._type === 'block')
    .map(block => {
      const text = block.children?.map(child => {
        let t = child.text || ''
        if (child.marks?.includes('strong')) t = `<strong>${t}</strong>`
        if (child.marks?.includes('em')) t = `<em>${t}</em>`
        return t
      }).join('') || ''
      
      if (block.listItem === 'bullet') {
        return `<li>${text}</li>`
      }
      return text
    })
    .join('\n')
}

// Build Highcharts config
function buildChartConfig(slide, parsedData) {
  const xAxisKey = Object.keys(parsedData[0])[0]
  const categories = parsedData.map(row => row[xAxisKey])
  
  const series = (slide.series || []).map(s => ({
    name: s.label,
    data: parsedData.map(row => row[s.dataColumn]),
    color: s.colour,
  }))

  const chartTypeMap = {
    line: 'line',
    column: 'column',
    bar: 'bar',
    area: 'area',
    stackedColumn: 'column',
    stackedArea: 'area',
  }

  const isStacked = slide.chartType?.includes('stacked')

  return {
    chart: {
      type: chartTypeMap[slide.chartType] || 'line',
      style: {fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},
      backgroundColor: 'transparent',
    },
    title: {text: null},
    xAxis: {
      categories: categories,
      title: {text: slide.xAxisLabel || null},
      labels: {style: {color: '#6B7280'}},
      lineColor: '#E5E7EB',
    },
    yAxis: {
      title: {text: slide.yAxisLabel || null},
      labels: {
        style: {color: '#6B7280'},
      },
      gridLineColor: '#E5E7EB',
    },
    legend: {
      align: 'left',
      verticalAlign: 'top',
      itemStyle: {color: '#374151', fontWeight: 'normal'},
    },
    plotOptions: {
      series: {
        animation: {duration: 1000},
        marker: {enabled: false},
      },
      column: {stacking: isStacked ? 'normal' : undefined},
      area: {stacking: isStacked ? 'normal' : undefined, fillOpacity: 0.3},
    },
    series: series,
    credits: {enabled: false},
  }
}

// Generate HTML
function generateHTML(slide) {
  const theme = themeColours[slide.themeColour] || themeColours.teal
  const parsedData = slide.chartData ? parseCSV(slide.chartData) : []
  const chartConfig = buildChartConfig(slide, parsedData)
  const commentary = portableTextToHTML(slide.body)
  
  const isChartLeft = slide.layout === 'chartLeft'
  const isChartFull = slide.layout === 'chartFull'

  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${slide.title || 'GMO Slide'}</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #00005E 0%, #1a1a7a 100%);
      color: white;
      min-height: 100vh;
    }
    
    .slide {
      display: grid;
      grid-template-columns: ${isChartFull ? '1fr' : isChartLeft ? '1.2fr 1fr' : '1fr 1.2fr'};
      gap: 3rem;
      padding: 4rem;
      min-height: 100vh;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .content {
      order: ${isChartLeft ? '2' : '1'};
    }
    
    .chart-container {
      order: ${isChartLeft ? '1' : '2'};
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 700;
      margin-bottom: 0.75rem;
      line-height: 1.1;
    }
    
    h2 {
      font-size: clamp(1rem, 2vw, 1.25rem);
      font-weight: 400;
      opacity: 0.8;
      margin-bottom: 2rem;
    }
    
    .commentary {
      list-style: none;
      padding: 0;
    }
    
    .commentary li {
      padding: 0.875rem 0;
      padding-left: 1.75rem;
      position: relative;
      font-size: 1.0625rem;
      line-height: 1.6;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .commentary li:last-child {
      border-bottom: none;
    }
    
    .commentary li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 1.2rem;
      width: 8px;
      height: 8px;
      background: ${theme.accent};
      border-radius: 50%;
    }
    
    .source {
      margin-top: 2rem;
      font-size: 0.875rem;
      opacity: 0.5;
    }
    
    #chart {
      width: 100%;
      height: 400px;
    }
    
    @media (max-width: 900px) {
      .slide {
        grid-template-columns: 1fr;
        padding: 2rem;
      }
      .content, .chart-container {
        order: unset;
      }
    }
  </style>
</head>
<body>
  <div class="slide">
    <div class="content">
      <h1>${slide.title || ''}</h1>
      <h2>${slide.subtitle || ''}</h2>
      <ul class="commentary">
        ${commentary}
      </ul>
      <p class="source">Source: ${slide.source || ''}</p>
    </div>
    <div class="chart-container">
      <div id="chart"></div>
    </div>
  </div>

  <script>
    const chartConfig = ${JSON.stringify(chartConfig, null, 2)};
    Highcharts.chart('chart', chartConfig);
    
    gsap.from('h1', {opacity: 0, y: 30, duration: 0.8, delay: 0.2, ease: 'power3.out'});
    gsap.from('h2', {opacity: 0, y: 20, duration: 0.6, delay: 0.4, ease: 'power3.out'});
    gsap.from('.commentary li', {opacity: 0, x: -20, duration: 0.5, stagger: 0.1, delay: 0.6, ease: 'power2.out'});
    gsap.from('.chart-container', {opacity: 0, scale: 0.95, duration: 0.8, delay: 0.3, ease: 'power3.out'});
  </script>
</body>
</html>`
}

// Main build function
async function build() {
  console.log('Fetching slide from Sanity...')
  
  const slide = await client.fetch('*[_type == "slide"][0]')
  
  if (!slide) {
    console.error('No slide found in Sanity. Create one first!')
    process.exit(1)
  }
  
  console.log(`Building: ${slide.title}`)
  
  const html = generateHTML(slide)
  
  if (!fs.existsSync('output')) {
    fs.mkdirSync('output')
  }
  
  fs.writeFileSync('output/slide.html', html)
  console.log('')
  console.log('âœ“ Built successfully!')
  console.log('')
  console.log('Open this file in your browser:')
  console.log('C:\\Users\\User\\gmo-builder\\output\\slide.html')
}

build().catch(console.error)