<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GMO Chart Recommender</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 2rem;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: #00005E;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 2rem;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      color: #333;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    
    .input-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .tab {
      padding: 0.75rem 1.25rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 0.95rem;
      color: #666;
      transition: all 0.2s;
    }
    
    .tab:hover {
      color: #00005E;
    }
    
    .tab.active {
      color: #00005E;
      border-bottom-color: #00A3A3;
      font-weight: 500;
    }
    
    .input-section {
      display: none;
    }
    
    .input-section.active {
      display: block;
    }
    
    .file-upload-area {
      border: 2px dashed #e0e0e0;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .file-upload-area:hover {
      border-color: #00A3A3;
      background: #f8f9fa;
    }
    
    .file-upload-area.dragover {
      border-color: #00A3A3;
      background: #e8f4f4;
    }
    
    .file-input {
      display: none;
    }
    
    .file-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: #00A3A3;
    }
    
    .file-upload-text {
      color: #666;
      margin-bottom: 0.5rem;
    }
    
    .file-upload-hint {
      font-size: 0.875rem;
      color: #999;
    }
    
    .file-name {
      margin-top: 1rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .file-name-text {
      color: #333;
      font-size: 0.9rem;
    }
    
    .remove-file {
      background: none;
      border: none;
      color: #c00;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.25rem 0.5rem;
    }
    
    .remove-file:hover {
      text-decoration: underline;
    }
    
    textarea {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }
    
    #csv-input {
      height: 200px;
    }
    
    textarea:focus {
      outline: none;
      border-color: #00A3A3;
    }
    
    button {
      background: #00005E;
      color: white;
      border: none;
      padding: 0.875rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
      width: 100%;
    }
    
    button:hover {
      background: #000080;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .button-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .button-row button {
      margin-top: 0;
    }
    
    .secondary-button {
      background: #6B7280;
    }
    
    .secondary-button:hover {
      background: #4B5563;
    }
    
    .recommendation {
      margin-top: 1rem;
    }
    
    .rec-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #eee;
    }
    
    .rec-item:last-child {
      border-bottom: none;
    }
    
    .rec-label {
      color: #666;
      font-size: 0.875rem;
    }
    
    .rec-value {
      color: #333;
      font-weight: 500;
    }
    
    .series-list {
      margin-top: 0.5rem;
    }
    
    .series-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      font-size: 0.875rem;
    }
    
    .colour-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .reasoning {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.875rem;
      color: #555;
      line-height: 1.5;
    }
    
    .refinement-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid #e0e0e0;
    }
    
    .refinement-header {
      font-size: 0.95rem;
      color: #333;
      margin-bottom: 0.75rem;
      font-weight: 500;
    }
    
    .refinement-input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 60px;
    }
    
    .refinement-input:focus {
      outline: none;
      border-color: #00A3A3;
    }
    
    .refinement-examples {
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.5rem;
      font-style: italic;
    }
    
    .refinement-history {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .refinement-history-title {
      font-size: 0.875rem;
      color: #666;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .refinement-history-item {
      font-size: 0.85rem;
      color: #555;
      padding: 0.4rem 0;
      padding-left: 1rem;
      position: relative;
    }
    
    .refinement-history-item::before {
      content: '‚úì';
      position: absolute;
      left: 0;
      color: #00A3A3;
      font-weight: bold;
    }
    
    #chart-container {
      margin-top: 1rem;
      min-height: 300px;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    
    .error {
      background: #fee;
      color: #c00;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    
    .success {
      background: #efe;
      color: #060;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>GMO Chart Recommender</h1>
    <p class="subtitle">Upload a file or paste data to get an AI-powered chart recommendation</p>
    
    <div class="grid">
      <div class="card">
        <h2>1. Provide Your Data</h2>
        
        <div class="input-tabs">
          <button class="tab active" onclick="switchTab('upload')">üìÅ Upload File</button>
          <button class="tab" onclick="switchTab('paste')">üìã Paste CSV</button>
        </div>
        
        <!-- File Upload Section -->
        <div id="upload-section" class="input-section active">
          <div class="file-upload-area" id="dropzone" onclick="document.getElementById('file-input').click()">
            <div class="file-icon">üìä</div>
            <div class="file-upload-text">Click to upload or drag and drop</div>
            <div class="file-upload-hint">Supports: .xlsx, .xls, .csv (Max 10MB)</div>
          </div>
          <input type="file" id="file-input" class="file-input" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(event)">
          
          <div id="file-name-display" class="file-name hidden">
            <span class="file-name-text" id="file-name-text"></span>
            <button class="remove-file" onclick="removeFile()">Remove</button>
          </div>
          
          <div id="upload-success" class="success hidden"></div>
        </div>
        
        <!-- Paste CSV Section -->
        <div id="paste-section" class="input-section">
          <textarea id="csv-input" placeholder="date,fed,ecb,boe
Jan 2022,0.25,0.00,0.25
Apr 2022,0.50,0.00,0.75
Jul 2022,2.50,0.50,1.25
Oct 2022,3.25,1.25,2.25
Jan 2023,4.50,2.50,3.50"></textarea>
        </div>
        
        <button id="analyse-btn" onclick="analyseData()">Analyse Data</button>
        
        <div id="error" class="error hidden"></div>
      </div>
      
      <div class="card">
        <h2>2. Recommendation</h2>
        <div id="loading" class="loading hidden">Analysing your data...</div>
        <div id="recommendation" class="recommendation hidden"></div>
        <div id="chart-container"></div>
        
        <!-- Refinement Section -->
        <div id="refinement-section" class="refinement-section hidden">
          <div class="refinement-header">üí¨ Refine this chart:</div>
          <textarea 
            id="refinement-input" 
            class="refinement-input" 
            placeholder="E.g., 'Show every year on the x-axis' or 'Change to a column chart' or 'Use red for the main line'"
          ></textarea>
          <div class="refinement-examples">
            Try: "Show every year" ‚Ä¢ "Change to column chart" ‚Ä¢ "Remove the ECB series"
          </div>
          <div class="button-row">
            <button id="refine-btn" onclick="refineChart()">Refine Chart</button>
            <button class="secondary-button" onclick="startOver()">Start Over</button>
          </div>
          
          <div id="refinement-history" class="refinement-history hidden">
            <div class="refinement-history-title">Refinements applied:</div>
            <div id="refinement-history-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentRecommendation = null;
    let currentData = '';
    let uploadedFile = null;
    let originalRecommendation = null;
    let refinementHistory = [];

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.querySelectorAll('.input-section').forEach(s => s.classList.remove('active'));
      if (tab === 'upload') {
        document.getElementById('upload-section').classList.add('active');
      } else {
        document.getElementById('paste-section').classList.add('active');
      }
      
      document.getElementById('error').classList.add('hidden');
    }

    // Drag and drop handlers
    const dropzone = document.getElementById('dropzone');
    
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    
    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });
    
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    // File selection handler
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    // File upload handler
    async function handleFile(file) {
      const error = document.getElementById('error');
      const success = document.getElementById('upload-success');
      const fileNameDisplay = document.getElementById('file-name-display');
      const fileNameText = document.getElementById('file-name-text');
      
      error.classList.add('hidden');
      success.classList.add('hidden');
      
      const validTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
      const validExtensions = ['.csv', '.xlsx', '.xls'];
      const hasValidExtension = validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
      
      if (!validTypes.includes(file.type) && !hasValidExtension) {
        error.textContent = 'Invalid file type. Please upload a CSV or Excel file.';
        error.classList.remove('hidden');
        return;
      }
      
      if (file.size > 10 * 1024 * 1024) {
        error.textContent = 'File too large. Maximum size is 10MB.';
        error.classList.remove('hidden');
        return;
      }
      
      fileNameText.textContent = file.name;
      fileNameDisplay.classList.remove('hidden');
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        currentData = data.csvData;
        uploadedFile = file;
        
        success.textContent = `‚úì File uploaded successfully! Ready to analyse.`;
        success.classList.remove('hidden');
        
      } catch (err) {
        error.textContent = 'Upload failed: ' + err.message;
        error.classList.remove('hidden');
        fileNameDisplay.classList.add('hidden');
      }
    }

    // Remove file
    function removeFile() {
      document.getElementById('file-input').value = '';
      document.getElementById('file-name-display').classList.add('hidden');
      document.getElementById('upload-success').classList.add('hidden');
      currentData = '';
      uploadedFile = null;
    }

    // Analyse data
    async function analyseData() {
      const btn = document.getElementById('analyse-btn');
      const loading = document.getElementById('loading');
      const recommendation = document.getElementById('recommendation');
      const error = document.getElementById('error');
      const chartContainer = document.getElementById('chart-container');
      const refinementSection = document.getElementById('refinement-section');
      
      error.classList.add('hidden');
      recommendation.classList.add('hidden');
      chartContainer.innerHTML = '';
      refinementSection.classList.add('hidden');
      
      let csvData;
      const activeTab = document.querySelector('.tab.active').textContent.includes('Upload') ? 'upload' : 'paste';
      
      if (activeTab === 'upload') {
        csvData = currentData;
      } else {
        csvData = document.getElementById('csv-input').value.trim();
      }
      
      if (!csvData) {
        error.textContent = activeTab === 'upload' 
          ? 'Please upload a file first' 
          : 'Please paste some data first';
        error.classList.remove('hidden');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Analysing...';
      loading.classList.remove('hidden');
      
      try {
        const response = await fetch('/api/analyse', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ csvData })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        currentRecommendation = data;
        originalRecommendation = data;
        currentData = csvData;
        refinementHistory = ['Initial recommendation'];
        
        displayRecommendation(data);
        renderChart(data, csvData);
        
        // Show refinement section
        refinementSection.classList.remove('hidden');
        updateRefinementHistory();
        
      } catch (err) {
        error.textContent = 'Error: ' + err.message;
        error.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Analyse Data';
        loading.classList.add('hidden');
      }
    }

    // Refine chart
    async function refineChart() {
      const refinementInput = document.getElementById('refinement-input');
      const refinementRequest = refinementInput.value.trim();
      const refineBtn = document.getElementById('refine-btn');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      
      if (!refinementRequest) {
        error.textContent = 'Please enter a refinement instruction';
        error.classList.remove('hidden');
        return;
      }
      
      error.classList.add('hidden');
      refineBtn.disabled = true;
      refineBtn.textContent = 'Refining...';
      loading.classList.remove('hidden');
      
      try {
        const response = await fetch('/api/refine', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            csvData: currentData,
            currentRecommendation: currentRecommendation,
            refinementRequest: refinementRequest
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        currentRecommendation = data;
        refinementHistory.push(refinementRequest);
        
        displayRecommendation(data);
        renderChart(data, currentData);
        updateRefinementHistory();
        
        // Clear input
        refinementInput.value = '';
        
      } catch (err) {
        error.textContent = 'Refinement error: ' + err.message;
        error.classList.remove('hidden');
      } finally {
        refineBtn.disabled = false;
        refineBtn.textContent = 'Refine Chart';
        loading.classList.add('hidden');
      }
    }

    // Start over
    function startOver() {
      if (originalRecommendation) {
        currentRecommendation = originalRecommendation;
        refinementHistory = ['Initial recommendation'];
        
        displayRecommendation(currentRecommendation);
        renderChart(currentRecommendation, currentData);
        updateRefinementHistory();
        
        document.getElementById('refinement-input').value = '';
        document.getElementById('error').classList.add('hidden');
      }
    }

    // Update refinement history display
    function updateRefinementHistory() {
      const historyContainer = document.getElementById('refinement-history');
      const historyList = document.getElementById('refinement-history-list');
      
      if (refinementHistory.length > 1) {
        historyContainer.classList.remove('hidden');
        historyList.innerHTML = refinementHistory
          .slice(1) // Skip "Initial recommendation"
          .map(item => `<div class="refinement-history-item">${item}</div>`)
          .join('');
      } else {
        historyContainer.classList.add('hidden');
      }
    }

    function displayRecommendation(rec) {
      const container = document.getElementById('recommendation');
      
      const seriesHtml = rec.series.map(s => `
        <div class="series-item">
          <span class="colour-dot" style="background: ${s.colour}"></span>
          <span>${s.label}</span>
          <span style="color: #999; font-size: 0.75rem;">(${s.dataColumn})</span>
        </div>
      `).join('');
      
      container.innerHTML = `
        <div class="rec-item">
          <span class="rec-label">Chart Type</span>
          <span class="rec-value">${rec.chartType.charAt(0).toUpperCase() + rec.chartType.slice(1)} Chart</span>
        </div>
        <div class="rec-item">
          <span class="rec-label">X-Axis</span>
          <span class="rec-value">${rec.xAxisLabel || 'Auto'}</span>
        </div>
        <div class="rec-item">
          <span class="rec-label">Y-Axis</span>
          <span class="rec-value">${rec.yAxisLabel || 'Auto'} (${rec.yAxisFormat || 'number'})</span>
        </div>
        <div class="rec-item" style="flex-direction: column; align-items: flex-start;">
          <span class="rec-label">Data Series</span>
          <div class="series-list">${seriesHtml}</div>
        </div>
        <div class="reasoning">
          <strong>Why this chart:</strong> ${rec.reasoning}
        </div>
      `;
      
      container.classList.remove('hidden');
    }

    function renderChart(rec, csvData) {
      const lines = csvData.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const data = lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => {
          const val = values[i]?.trim();
          obj[h] = isNaN(val) ? val : parseFloat(val);
        });
        return obj;
      });
      
      const xKey = headers[0];
      const categories = data.map(row => row[xKey]);
      
      const series = rec.series.map(s => ({
        name: s.label,
        data: data.map(row => row[s.dataColumn]),
        color: s.colour
      }));
      
      Highcharts.chart('chart-container', {
        chart: {
          type: rec.chartType,
          style: { fontFamily: '-apple-system, BlinkMacSystemFont, sans-serif' }
        },
        title: { text: rec.title || null },
        xAxis: {
          categories: categories,
          title: { text: rec.xAxisLabel }
        },
        yAxis: {
          title: { text: rec.yAxisLabel },
          labels: {
            formatter: function() {
              if (rec.yAxisFormat === 'percent') return this.value + '%';
              if (rec.yAxisFormat === 'currency') return '$' + this.value;
              return this.value;
            }
          }
        },
        legend: {
          align: 'left',
          verticalAlign: 'top'
        },
        plotOptions: {
          series: { marker: { enabled: false } }
        },
        series: series,
        credits: { enabled: false }
      });
    }

    // Allow Enter key to trigger refinement
    document.addEventListener('DOMContentLoaded', () => {
      const refinementInput = document.getElementById('refinement-input');
      refinementInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          refineChart();
        }
      });
    });
  </script>
</body>
</html>